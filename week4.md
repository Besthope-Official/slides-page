# è¿™ä¸¤å‘¨çš„å·¥ä½œæ±‡æŠ¥

### ä¸ºå•¥ä¸Šå‘¨æ²¡å¼€ä¼š

- åç«¯éƒ¨é•¿éƒ½åœ¨çˆ†è‚æ¯”èµ›é¡¹ç›®
- æ˜¯æ—¶å€™ç»™ä½ ä»¬çœ‹çœ‹æˆ‘çš„ Github commit è®°å½•äº†
  - å¤§å®¶ä¹Ÿè¦æœ‰è¿™ç§å†™é¡¹ç›®çš„çƒ­æƒ…ğŸ˜‚

<div align="center"><img src="./images/diligent.png" alt="çœŸå¾—å‹¤å¥‹å§"></div>

- è€Œä¸”å¾ˆå¤šåŒå­¦æœ‰äº‹æ¥ä¸äº†
- **åæ€**: æ˜¯å¼€ä¼šå¼ºåº¦æœ‰äº›é«˜äº†ä¹ˆ ğŸ§

<!-- vslide -->

# è¿™ä¸¤å‘¨çš„å·¥ä½œæ±‡æŠ¥

### å¹»ç¯ç‰‡æ¨¡æ¿

ç»™å¼€ä¼šç”¨çš„ slides å†™äº†ä¸€ä¸ªæ¨¡æ¿ [revealjs-academic-theme](https://github.com/Besthope-Official/revealjs-academic-theme)

- åŸºäº reveal.js, åˆ¶ä½œçš„å­¦æœ¯é£æ ¼çš„æ¨¡æ¿
- ä»¿çš„æ˜¯ NJU OS è¯¾, ä»¥åŠ Latex Beamer çš„é£æ ¼
- ç°åœ¨å†™ markdown å°±èƒ½å¿«é€Ÿç”Ÿæˆ PPT ç®€ç›´ä¸è¦å¤ªçˆ½ ğŸ¤¤
- æ¬¢è¿å¤§å®¶è¯•ç”¨
  - ä¹Ÿå¯ä»¥æ¯”æ–¹è¯´ç»™ç‚¹ star é¼“åŠ±ä¸€ä¸‹ (
- æ¬¢è¿å¤§å®¶çš„å»ºè®¾æ€§å»ºè®®, ä¸€èµ·æ¥å®Œå–„è¿™ä¸ªæ¨¡æ¿

<!-- vslide -->

# è¿™ä¸¤å‘¨çš„å·¥ä½œæ±‡æŠ¥

### SWUFE-OJ

- æ–‡æ¡£[ä¸Šçº¿](https://singularity-backend.gitbook.io/backend-online-doc/swufe-oj/readme): å…¶å®å°±æ˜¯ä¹‹å‰åŠè®­ç»ƒè¥ç”¨çš„ gitbook çš„æ–°é¡µ
- è®¾ç½®æ”¹æˆäº†å¯†é’¥(ä¸æš´éœ²æ•°æ®åº“å¯†ç äº†), æœ¬åœ°é…ç½®å‚è€ƒ README
  - å¯¹åº”çš„è¦æ”¹ä¸‹æ•°æ®åº“çš„å¯†ç å•¥çš„, é˜²æ­¢è¢«äººç¿» git log ç„¶å gg
- ç”¨æˆ·æ¨¡å—ç”¨ [SimpleJWT](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/) é‡æ–°æ”¹äº†ä¸‹, åŠ å…¥ Redis å®ç°äº† token ç¼“å­˜
- æŠŠæäº¤ submission æ¨¡å—çš„ä»£ç ä¿®æ”¹äº†ä¸‹

<!-- slide -->

# Review: Git åŠåŸºç¡€æ“ä½œ

ä¸Šä¸Šå‘¨è®²çš„ Git, ä½ è¿˜è®°å¾—å¤šå°‘...?

### æ‹·æ‰“æ—¶é—´

- **å¸¸å›å®¶çœ‹çœ‹**: è®°å¾—æŸ¥é˜…[è‡ªå®¶æ–‡æ¡£](https://singularity-backend.gitbook.io/backend-online-doc/) or [Pro Git](https://singularity-backend.gitbook.io/backend-online-doc/) å»äº†è§£ç›¸å…³æ¦‚å¿µ
  - æ–‡ä»¶ unstaged ä¸ºå•¥ä¸è®©æˆ‘æäº¤å•ŠğŸ˜µ...?
  - Git ä¸ºä»€ä¹ˆèƒ½æ£€æµ‹åˆ°æ¯æ¬¡ä¿®æ”¹çš„å˜åŠ¨?
- äº†è§£åˆ†å¸ƒå¼å¼€å‘å›¢é˜Ÿåä½œçš„æµç¨‹:
  - åˆ†æ”¯ç®¡ç†
  - å†²çªè§£å†³
  - æäº¤å‰ä½ å¿˜è®°å¯¹æœ¬åœ°ä»£ç æ›´æ–°äº†, å¯¼è‡´ git æ‹’ç»äº†ä½ çš„æ¨é€, ä½ è¦æ€ä¹ˆåš?
    - plan A: å¼ºåˆ¶æ¨é€ `git push -f`
    - plan B?
  - ä»€ä¹ˆæ˜¯ `git revert`?

<!-- slide -->

# åˆ°åº•ä»€ä¹ˆæ˜¯æŠ€æœ¯æ–‡æ¡£

Wikipedia: *Software documentation is written text or illustration that accompanies computer software or is embedded in the source code.* ğŸ¤“ğŸ‘†

<div align="center"><img src="images/2024-03-26-22-10-59.png" width="55%" height="55%" alt="ä»€ä¹ˆæ˜¯æ–‡æ¡£"></div>

<!-- vslide -->

# åˆ°åº•ä»€ä¹ˆæ˜¯æŠ€æœ¯æ–‡æ¡£

### ä»¥åˆšç»“æŸçš„èŠ±æ——æ¯æ¯”èµ›ä¸ºä¾‹:

ä½ å¾—æäº¤ä¸‰ä¸ªæŠ€æœ¯æ–‡æ¡£(ä¸¥æ ¼æ¥è¯´æ˜¯å…­ä¸ª)

- **éœ€æ±‚æ–‡æ¡£**: ä½ åšè¿™ä¸ªæ˜¯å¹²ä»€ä¹ˆçš„
- **ç”¨æˆ·æ–‡æ¡£**: ç”¨æˆ·æ€ä¹ˆç”¨
- **æµ‹è¯•æ–‡æ¡£**: éƒ½æµ‹è¯•äº†ä»€ä¹ˆåŠŸèƒ½

<div align="center"><img src="images/2024-03-26-20-47-02.png" width="75%" height="75%" alt="meme"></div>

å½“ç„¶, èŠ±æ——è¦äº¤çš„æŠ€æœ¯æ–‡æ¡£, è€ƒéªŒçš„å…¶å®æ˜¯ä½ çš„è¯­è¨€ç»„ç»‡å’Œæ‰¯åºŸè¯èƒ½åŠ›...

<!-- vslide -->

# åˆ°åº•ä»€ä¹ˆæ˜¯æŠ€æœ¯æ–‡æ¡£

çœ‹çœ‹ä¼˜ç§€å¼€æºé¡¹ç›®çš„æ–‡æ¡£

- æ¡†æ¶æ–‡æ¡£: [Django](https://docs.djangoproject.com/zh-hans/5.0/)
- å¼€æºé¡¹ç›®æ–‡æ¡£: [å…¨æ ˆ FastAPI é¡¹ç›®æ¨¡æ¿](https://github.com/tiangolo/full-stack-fastapi-template)

<br>
<br>

### æ€»ç»“

- æ˜ç¡®**å—ä¼—**ç›®æ ‡: ç”¨æˆ·ç¾¤ä½“, å¼€å‘äººå‘˜, éƒ¨ç½²äººå‘˜éƒ½åº”å½“æœ‰å¯¹åº”çš„æ–‡æ¡£
- **ç¤ºä¾‹**: ä» Getting Started å¼€å§‹, é€æ­¥æ·±å…¥
- åŠæ—¶**æ›´æ–°**å’Œ**ç‰ˆæœ¬æ§åˆ¶**: æ”¹åŠ¨ç‰ˆæœ¬å· + VCS ç®¡ç†

Web åº”ç”¨å¼€å‘çš„æ–‡æ¡£ä¼šæ¯”ä¸Šé¢çš„ç®€å•ä¸€äº›, æˆ‘ä»¬å†™çš„æ˜¯**æ¥å£æ–‡æ¡£**

<!-- slide -->

# ä»€ä¹ˆæ˜¯æ¥å£æ–‡æ¡£

åç«¯è¯´ç™½äº†å°±æ˜¯**å†™æ¥å£(API)**

- æ¥å£æ–‡æ¡£å°±æ˜¯åç«¯ç»™å‰ç«¯æä¾› API çš„æŠ€æœ¯æ–‡æ¡£
- å‰ç«¯æœ‰äº†æ¥å£æ–‡æ¡£æ‰èƒ½çœŸæ­£å’Œåç«¯è¿é€š

<br>
<br>

### æ¥å£æ–‡æ¡£åŒ…å«çš„å†…å®¹

- ä»‹ç»
- æ¥å£åˆ—è¡¨
- è¯·æ±‚å‚æ•°å’Œå“åº”å‚æ•°è¯´æ˜
- é”™è¯¯ç è¯´æ˜
- å˜æ›´æ—¥è®° Changelog

<!-- vslide -->

# ä»€ä¹ˆæ˜¯æ¥å£æ–‡æ¡£

### RESTful API æ¥å£æ–‡æ¡£

- å¤§éƒ¨åˆ†çš„ web é¡¹ç›®éƒ½æ˜¯åŸºäº REST é£æ ¼çš„ API è®¾è®¡çš„
- REST: Representational State Transfer
  - æŠŠä¸€åˆ‡ä¿¡æ¯å½“ä½œ**èµ„æº**, ä»¥ URI è¡¨ç°
  - ä¸€ç§èµ„æºçš„**è¡¨ç°**å½¢å¼å¯èƒ½å¤šç§å¤šæ ·(`json` or `xml`)
  - HTTP æ–¹æ³•æ¥è¡¨ç°èµ„æºçš„**çŠ¶æ€è½¬ç§»**(å¢åˆ æ”¹æŸ¥)

æ¯”æ–¹è¯´ `GET https://api.github.com/users/:user`

- `GET` æ–¹æ³•: æŸ¥è¯¢
- `user` è¯·æ±‚å‚æ•°
- ä»ç«¯å£ä¸Šå°±å¯ä»¥çŸ¥é“è¿™ä¸ªæ¥å£çš„å«ä¹‰: æŸ¥è¯¢æŸä¸ª Github ç”¨æˆ·çš„ä¿¡æ¯

<!-- vslide -->

# åœ¨ä½ å†™ä»£ç ä¹‹å‰...

### æ€è€ƒå¥½ä½ è¦è®¾è®¡çš„åŠŸèƒ½

- å°è¯•å»åˆ†è§£é—®é¢˜ä¸ºä¸€ä¸ªä¸ªå°çš„æ¨¡å—
- å½“ä½ ä¸€ç­¹è«å±•çš„æ—¶å€™, ä½ ä¹Ÿå¯ä»¥å»é—®é—® GPT:

<div align="center"><img src="images/2024-03-27-09-23-35.png" width="50%" height="50%" alt="meme"></div>

<!-- vslide -->

# æ€è€ƒ & è®¨è®º

é—®é—®è‡ªå·±ä¸‹é¢è¿™äº›é—®é¢˜

- æœ‰å“ªäº›åŠŸèƒ½æ˜¯æˆ‘å¯ä»¥ä¿ç•™çš„?
- å¯¹åº”æ¨¡å—çš„å­˜å‚¨ç»“æ„åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„?
- å¯¹äºå…³ç³»å‹æ•°æ®åº“: ç”¨æˆ·, æˆ¿é—´, æ’è¡Œæ¦œ, æ¶ˆæ¯ä¹‹é—´çš„å…³ç³»?
  - ç”¨æˆ·è¡¨åŒ…å«å“ªäº›å­—æ®µ, å­—æ®µç±»å‹/çº¦æŸæ¡ä»¶...
  - ä¸€å¯¹å¤šå…³ç³», å¤–é”®/ç´¢å¼•çš„è®¾ç½®
- ä¸€äº›åœ¨é¡¹ç›®åˆå°±è¦å®šå¥½çš„**æŠ€æœ¯å®ç°**
  - ç™»å½•ç³»ç»Ÿåš jwt è¿˜æ˜¯ session + cookie?
  - å‰ç«¯è½®è¯¢ or websockets?

> ä»»ä½•å«ç³Šçš„åœ°æ–¹, åœ¨å°†æ¥éƒ½ä¼šå˜æˆå›æ—‹é•–...

<!-- vslide -->

# so... why tech doc?

### æŠ€æœ¯æ–‡æ¡£é«˜æ•ˆå‡å°‘äº†äº¤æµæˆæœ¬

- åœ¨å›¢é˜Ÿåä½œçš„è¿‡ç¨‹ä¸­, **æ²¡äººæ˜¯ä¸ªå­¤å²›**
- ä½ å†™çš„ä»£ç , åˆ«äººæ˜¯è¦çœ‹ä½ çš„ä»£ç å¯¹æ¥çš„(åç«¯å›¢é˜Ÿå†…)
- ä½ å†™çš„æ¥å£, å‰ç«¯åŒå­¦ä¹Ÿè¦å’Œä½ å¯¹æ¥(å‰åç«¯åä½œ)
- å¸®åˆ«äººæ‹æ‹ä»£ç é€»è¾‘, å¯¹è‡ªå·±ç¼–å†™ä»£ç ä¹Ÿæœ‰å¥½å¤„(è¯´ä¸å®šè¿˜èƒ½æ‰¾åˆ°æ½œåœ¨ BUG)

å–œæ¬¢å¾®ä¿¡è¢«ç‹‚è½°çƒ‚ç‚¸å—

- ä½ è¯´çš„å¯¹, ä½†æ˜¯ `AxiosError { message:'Request failed with status code 400' ... }`
  - BAD REQUEST
- `Uncaught runtime errors: ...`
- æ€ä¹ˆæ”¹å­—æ®µäº† `user_name` -> `userName` ğŸ¤¯
  - å–œæ¬¢ä¸å†™ changelog

<!-- vslide --> 

# so... why tech doc?

### æˆ‘ä»¬éƒ½æ˜¯é æŠ€æœ¯æ–‡æ¡£æˆé•¿çš„

- å‡å¦‚æ²¡æœ‰æ•™ç¨‹, æ²¡æœ‰ç½‘ä¸Šæ€»ç»“çš„ç»éªŒå¸–
- ä½ è¦æ€ä¹ˆ**ç‹¬ç«‹è‡ªä¸»**åœ°å»è§£å†³é—®é¢˜?
- ä½ åªèƒ½é è‡ªå·±é€šè¿‡é˜…è¯»æ–‡æ¡£å»å­¦ä¹ 

<br>
<br>

### è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åå¯¹èƒæ•™å¼çš„æ•™å­¦

- æ²¡äº† tutorial, å¯¸æ­¥éš¾è¡Œ âŒ

<!-- slide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡

**è¦å®ç°çš„åŠŸèƒ½**

- å‡è®¾å•åœºå¯¹å±€æ ¹æ®ç©å®¶æ¶ˆå»çš„è¡Œæ•°å¯ä»¥è®¡ç®—å¾—åˆ†, æˆ‘ä»¬å¯ä»¥å¾—åˆ°å•æ¬¡å¯¹å±€çš„ç»“æœ.
- å•æ¬¡å¯¹å±€èƒœåˆ©å¯ä»¥æå‡ç©å®¶çš„ç§¯åˆ†
- æ ¹æ®ç©å®¶çš„ç§¯åˆ†å¯ä»¥è®¡ç®—å‡ºæ’è¡Œæ¦œ

**å‰ç«¯ç”»å‡ºåŸå‹å›¾** ğŸŒ¶

<div align="center"><img src="images/2024-03-27-12-57-34.png" width="75%" height="75%" alt="åŸå‹å›¾"></div>

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡

**æ€è€ƒä¸‹æµç¨‹**

- å‰ç«¯å‘èµ·å¯¹å±€è¯·æ±‚, åç«¯åˆ›å»ºæ¸¸æˆè®°å½•, åŒæ—¶ä¸¤äººå¼€å§‹å„è‡ªçš„æ¸¸æˆ
- ç©å®¶å•åœºæ¸¸æˆç»“æŸ, å‰ç«¯æäº¤ç©å®¶çš„ Game è®°å½•, åç«¯ä¿®æ”¹å¯¹å±€æ•°æ®åˆ°æ•°æ®åº“(å•äººæ¨¡å¼åˆ°æ­¤ä¸ºæ­¢)
- å¤šäººæ¨¡å¼ä¸­, å‰ç«¯ç›‘å¬ (è¯•è¯• `websockets`) å¯¹å±€ç»“æœ, ç­‰å¾…åŒæ–¹ç©å®¶éƒ½æäº¤ç»“æœå, åç«¯ç»“ç®—å¯¹å±€
- å‰ç«¯æ˜¾ç¤ºç»“ç®—ç”»é¢

**åˆ†å·¥åˆ’åˆ†**: å˜æ¸…å“ªäº›æ˜¯å‰ç«¯å†™çš„, å“ªäº›æ˜¯åç«¯å†™çš„, å¾ˆé‡è¦

å¯ä»¥çš„è¯, è¿˜å¯ä»¥ç”»ä¸€ä¸ªæµç¨‹å›¾

- è®¨è®ºçš„æ—¶å€™å¯ä»¥æ‰‹ç»˜
- è¯•è¯• [mermaid](https://mermaid.nodejs.cn/)
- å½“ç„¶ PPT å»ç”»ä¹Ÿå¯ä»¥...

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡

**æ•°æ®åº“è®¾è®¡**

- ç©å®¶è¡¨ Player: åŒ…å«ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯, ç§¯åˆ†, æ’å
- æ¸¸æˆè®°å½•è¡¨ Game: åŒ…å«ç©å®¶çš„æ¸¸æˆæ•°æ®, å¾—åˆ†, æ˜¯å¦ç»“æŸ
- å¯¹å±€è®°å½•è¡¨ Round: åŒ…å«å¯¹å±€çš„åŸºæœ¬ä¿¡æ¯, ç©å®¶çš„å¯¹å±€æ•°æ®, èƒœè´Ÿç»“æœ

è¿™äº›è¡¨çš„è®¾è®¡éœ€è¦åŒ…å«åœ¨æ¥å£æ–‡æ¡£ä¸­, å°±åƒä¸‹é¢è¿™æ ·

| å­—æ®µå | å­—æ®µç±»å‹         | é»˜è®¤å€¼ | ç¤ºä¾‹æ•°æ® |
|--------|------------------|--------|---------|
| id     | int   | è‡ªå¢   | 1       |
| name   | string  | æ—      | "é«˜è´µçš„å†…æµ‹ç©å®¶å“ˆå“ˆå“ˆ" |
| rank   | int   | 999    | 100     |
| score  | int   | 0      | 500     |

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡

**ç«¯å£å®šä¹‰** æŠŠä½ è¦å®ç°çš„åŠŸèƒ½å†™å‡ºå¯¹åº”çš„è·¯ç”±

- `POST /game` åˆ›å»ºæ¸¸æˆè®°å½•
- `PUT /game/:id` ä¿®æ”¹æ¸¸æˆè®°å½•
- `POST /round` åˆ›å»ºå¯¹å±€è®°å½•
- `PUT /round/:id` ä¿®æ”¹å¯¹å±€è®°å½•
- `GET /rank` è·å–æ’è¡Œæ¦œ

å¯¹äºæ¯ä¸ªè·¯ç”±, ä½ éœ€è¦å†™æ¸…éœ€è¦å“ªäº›å‚æ•°, ä»¥åŠä¸åŒæƒ…å†µå¯¹åº”çš„è¿”å›ç»“æœ.

- è¯·æ±‚å‚æ•°é•¿ä»€ä¹ˆæ ·: jQuery å‚æ•°, form-data...
- å„ç§æƒ…å†µä¸‹çš„é”™è¯¯ç , é”™è¯¯ä¿¡æ¯(æ–¹ä¾¿æˆ‘ä»¬å†™æµ‹è¯•)
- ç»™å‡ºä¸€äº›ç¤ºä¾‹

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡: å•å…ƒæµ‹è¯•ç¼–å†™

ç«¯å£è®¾è®¡å®Œæ¯•, ä½ å¯ä»¥æŠŠä»£ç çš„æ¥å£å…ˆå†™å‡ºæ¥(ç±»ä¼¼äº C é‡Œçš„å£°æ˜, Java é‡Œçš„ interface)

```py
@app.route('/game', methods=['POST'])
def start_game():
    pass

@app.route('/game/<int:game_id>', methods=['PUT'])
def end_game(game_id):
    pass
```

ç„¶åç€æ‰‹å»å†™å•å…ƒæµ‹è¯•(ä¸‹å‘¨ä¼šè®², å’•å’•å’•)

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡

çœŸçš„éœ€è¦æˆ‘æ‰‹å†™é‚£ä¹ˆå¤šä¸œè¥¿å—ğŸ˜µ

**ç›¸å…³å·¥å…·**

- Postman: API çš„ IDE
- Swagger: ä¾‹å¦‚ `flasgger` è‡ªåŠ¨ç”Ÿæˆ `flask` çš„æ¥å£æ–‡æ¡£é¡µé¢
- showdoc: å¯éƒ¨ç½²åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šçš„å¼€æºé¡¹ç›®
- ...

æ¡†æ¶åŸºæœ¬æ­å¥½äº†, ç„¶åä½ å°±å¯ä»¥è¿›å…¥å¿«ä¹çš„ coding é˜¶æ®µäº†.

### æ€»ç»“

- ä¸è¦ä¸€ä¸Šæ¥å°±å†™ä»£ç 
- åœ¨ AI æ—¶ä»£, **ä½ çš„è„‘å­æ¯”ä½ è®°ä»£ç æ›´æœ‰ç”¨**.

<!-- vslide -->

# L1: æ’è¡Œæ¦œæ¥å£è®¾è®¡: æ¥å£ç¤ºä¾‹

### å¼€å§‹æ¸¸æˆ

ç«¯å£: `POST /game`

#### è¯·æ±‚å‚æ•°

| å‚æ•°å    | ç±»å‹   | æè¿°       |
|----------|--------|------------|
| `game_type` | å­—ç¬¦ä¸² | æ¸¸æˆç±»å‹   |
| `player_id` | æ•´æ•°   | ç©å®¶ID     |

#### è¿”å›ç»“æœç¤ºä¾‹

```json
{
    "data": {
        "game_type": "multiplay",
        "id": 4,
        "player_id": 2,
        "score": 0,
        "timestamp": "2024-03-27 16:09:31"
    },
    "status": "sucess"
}
```

<!-- vslide -->

# L1: åç«¯ä»£ç ç¤ºä¾‹

[source code](https://github.com/Besthope-Official/backend/blob/master/demo/rankings-backend/server.py)

```py [28-42|45-68|71-87|117-126|129-141|144-162|165-192|195-205]
# tetris game online
import asyncio
import websockets

import os
import datetime
from dotenv import load_dotenv
from flask import Flask, request
from flask_sqlalchemy import SQLAlchemy

from utils import Result

# region: initialization & configuration

basedir = os.path.abspath(os.path.dirname(__name__))
load_dotenv('.env')

# initialize flask app and database
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get(
    'SQLALCHEMY_DATABASE_URI')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# models


class Player(db.Model):
    __tablename__ = 'players'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(50), nullable=False)
    rank = db.Column(db.Integer, nullable=False, default=999)
    score = db.Column(db.Integer, nullable=False, default=0)

    def to_json(self):
        return {
            'id': self.id,
            'name': self.name,
            'rank': self.rank,
            'score': self.score
        }


class Game(db.Model):
    __tablename__ = 'games'
    id = db.Column(db.Integer, primary_key=True)
    game_type = db.Column(db.String(50), nullable=False)
    score = db.Column(db.Integer, nullable=False, info='score of the game')
    timestamp = db.Column(db.DateTime, nullable=False,
                          default=datetime.datetime.now())
    is_finished = db.Column(db.Boolean, nullable=False, default=False)
    # relate to player column
    player_id = db.Column(db.Integer, db.ForeignKey(
        'players.id'), nullable=False)
    player = db.relationship('Player', backref=db.backref('games', lazy=True))

    def to_json(self):
        return {
            'id': self.id,
            'game_type': self.game_type,
            'player_id': self.player_id,
            'score': self.score,
            'timestamp': self.timestamp.strftime('%Y-%m-%d %H:%M:%S')
        }

    def __repr__(self):
        return f"Game(id={self.id}, game_type={self.game_type}, player_id={self.player_id}, score={self.score}, timestamp={self.timestamp})"


class Round(db.Model):
    __tablename__ = 'rounds'
    id = db.Column(db.Integer, primary_key=True)
    winner_id = db.Column(db.String(50), nullable=True)
    is_finished = db.Column(db.Boolean, nullable=True, default=False)
    # game 1
    game_id = db.Column(db.Integer, db.ForeignKey('games.id'), nullable=False)
    # game 2
    game_id2 = db.Column(db.Integer, db.ForeignKey('games.id'), nullable=False)

    def to_json(self):
        return {
            'id': self.id,
            'winner_id': self.winner_id,
            'game_id': self.game_id,
            'game_id2': self.game_id2
        }

# endregion

# views

# region: test views, will be removed in production


@app.route('/admin/player', methods=['POST'])
def create_player():
    name = request.form.get('name')
    new_player = Player(name=name)
    db.session.add(new_player)
    db.session.commit()

    return Result.success(new_player.to_json())


@app.route('/admin/player/<int:player_id>', methods=['GET'])
def get_player(player_id):
    player = Player.query.filter_by(id=player_id).first()
    if player is None:
        return Result.error(404, 'Player not found.')

    return Result.success(player.to_json())

# endregion


@app.route('/game', methods=['POST'])
def start_game():
    game_type = request.form.get('game_type')
    player_id = request.form.get('player_id')

    new_game = Game(game_type=game_type, player_id=player_id, score=0)
    db.session.add(new_game)
    db.session.commit()

    return Result.success(new_game.to_json())


@app.route('/game/<int:game_id>', methods=['PUT'])
def end_game(game_id):
    score = request.form.get('score', type=int)
    game = Game.query.filter_by(id=game_id).first_or_404()

    if game.is_finished:
        return Result.error(400, 'Game has already ended.')

    game.is_finished = True
    game.score = score
    db.session.commit()

    return Result.success(game.to_json())


@app.route('/round', methods=['POST'])
def start_round():
    game1_id = request.form.get('game1_id')
    game2_id = request.form.get('game2_id')

    game1 = Game.query.filter_by(id=game1_id).first_or_404()
    game2 = Game.query.filter_by(id=game2_id).first_or_404()

    if game1.is_finished or game2.is_finished:
        return Result.error(400, 'Game has already ended.')

    if game1.game_type != "multiplay" or game2.game_type != "multiplay":
        return Result.error(400, 'Game type is not multiplay.')

    new_round = Round(game_id=game1_id, game_id2=game2_id)
    db.session.add(new_round)
    db.session.commit()

    return Result.success(new_round.to_json())


@app.route('/round/<int:round_id>', methods=['PUT'])
def end_round(round_id):
    round = Round.query.filter_by(id=round_id).first_or_404()

    if round.is_finished:
        return Result.error(400, 'Round has already ended.')

    game1 = Game.query.filter_by(id=round.game_id).first_or_404()
    game2 = Game.query.filter_by(id=round.game_id2).first_or_404()

    if not game1.is_finished:
        return Result.error(400, f"{game1.player.name}'s game is not over.")
    if not game2.is_finished:
        return Result.error(400, f"{game2.player.name}'s game is not over.")

    if game1.score > game2.score:
        winner_id = game1.player_id
    else:
        winner_id = game2.player_id

    winner = Player.query.filter_by(id=winner_id).first()
    winner.score += 10

    round.winner_id = winner_id
    round.is_finished = True
    db.session.commit()

    return Result.success(round.to_json())


@app.route('/rank', methods=['GET'])
def get_rank():
    players = Player.query.order_by(Player.score.desc()).all()
    rank = 1
    for player in players:
        player.rank = rank
        rank += 1

    db.session.commit()

    return Result.success([player.to_json() for player in players])


if __name__ == '__main__':
    app.run(debug=True)

```

<!-- slide -->

# æœ¬å‘¨ä»»åŠ¡

- å‚è€ƒå®Œæˆ tetris-online æ¥å£æ–‡æ¡£çš„ç¼–å†™
  - ä¸è¦æ±‚åƒè¿™é‡Œæè¿°çš„ä¸€æ ·è¯¦ç»†, ä½ å¯ä»¥è¿­ä»£æ›´æ–°
- å¼€å‘ OJ çš„åŒå­¦: æŒ‰ç…§ç±»ä¼¼çš„æ€è·¯, å¦‚æœä½ æœ‰ç©ºå°±å»å®Œå–„ OJ çš„æŠ€æœ¯æ–‡æ¡£
  - å¼€å‘ä»£ç çš„æ¥ç€å†™ ğŸ¥¹
  - è¿™æ˜¯æ•™å­¦å‘¨çš„**ç¬¬äº”å‘¨**
  - ä¸‹ä¸ªæœˆåº•å‰å‡º demo çœ‹æ¥å¾ˆæ‚¬

<div align="center"><img src="images/time-is-up.jpg" width="30%" height="30%" alt="meme"></div>

<!-- slide -->

# å‚è€ƒæ–‡æ¡£

- [æŠ€æœ¯æ–‡æ¡£å†™ä½œæŒ‡å—](https://write-the-document.readthedocs.io/)
- [ApiFox ã€ŠAPI æ¥å£æ–‡æ¡£ã€‹æ¨¡ç‰ˆä¸è¯´æ˜](https://apifox.com/apiskills/api-interface-documentation/)